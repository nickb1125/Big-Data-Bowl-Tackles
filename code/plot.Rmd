---
title: "plot.Rmd"
author: "Nick R. Bachelder"
date: "2023-11-07"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(here)
library(dplyr)
library(gtsummary)
library(ggplot2)
library(plyr)
library(gganimate)
library(ggforce)
library(animation)
library(ggrepel)
library(tidyr)
library(ggpubr)
library(viridis)
library(gt)
library(gtExtras)
```

```{r}
games <- read.csv(here::here("data/nfl-big-data-bowl-2024/games.csv"))
players <- read.csv(here::here("data/nfl-big-data-bowl-2024/players.csv")) %>% 
  rowwise() %>% dplyr::mutate(height = as.numeric(sub("\\-.*", "", height))*12 + as.numeric(sub('.+-(.+)', '\\1', height))) %>% ungroup() %>%
  dplyr::select(displayName, nflId, height, weight, position)
plays <- read.csv(here::here("data/nfl-big-data-bowl-2024/plays.csv"))
tackles <- read.csv(here::here("data/nfl-big-data-bowl-2024/tackles.csv"))
tracking <- do.call(rbind, lapply(seq(1, 9), function(week) {read.csv(here::here(paste0("data/nfl-big-data-bowl-2024/tracking_a_week_", week, ".csv")))}))
```

```{r}
plot_marginal_contribution <- function(game_id, play_id) {
  pred_df <- read.csv(paste0("/Users/nickbachelder/Desktop/Personal Code/Kaggle/Tackles/", game_id, "_", play_id, ".csv")) %>% dplyr::select(-X) %>%
      mutate(x = as.numeric(x), y = as.numeric(y))
  pred_no_original <- pred_df %>% filter(omit != 0)
  all_frames <- unique(pred_no_original$frameId)
  max_prob <- max(pred_no_original$upper)
  min_prob <- min(pred_no_original$lower)
  saveGIF({for (i in min(all_frames):max(all_frames)) {
    pred_df_frame <- pred_no_original %>% filter(frameId == i)
    p <- pred_df_frame %>% dplyr::select(-y) %>% group_by(omit, x) %>% dplyr::summarise(lower = sum(lower), upper = sum(upper), prob = sum(prob)) %>% ungroup() %>% 
      mutate(omit = as.factor(omit)) %>%
      ggplot() + geom_ribbon(aes(x = x, ymin = lower, ymax = upper), fill = "grey70") + geom_line(aes(x = x, y = prob)) + facet_wrap(~omit, ncol = 1) + theme_void() +
      theme(axis.title.x = element_text(),  axis.text.x = element_text(),  axis.ticks.x = element_line(), axis.title.y = element_text()) + ylim(min_prob, max_prob)
    print(p)
    print(paste0("Frame ", i))
    ani.pause()}
    },movie.name="facet_zoom_2.gif",ani.width = 600, ani.height = 600)
}

plot_play <- function(game_id, play_id) {
  pred_df <- read.csv(paste0("/Users/nickbachelder/Desktop/Personal Code/Kaggle/Tackles/", game_id, "_", play_id, ".csv")) %>% dplyr::select(-X) %>%
      mutate(x = as.numeric(x), y = as.numeric(y))
  play_df <- tracking %>% filter(gameId == game_id, playId == play_id) %>%
      dplyr::mutate(type = case_when(position %in% c("QB", "TE",  "WR", "G", "OLB", "RB", "C", "FB") ~ "offense", 
                               is.na(nflId) ~ "ball",
                               TRUE ~ "defense"))
    describe <- (plays %>% filter(gameId == game_id, playId == play_id))$playDescription[1]
    all_frames <- unique(play_df$frameId)
    max_p <- max(pred_df$prob)
    oopt = ani.options(interval = 1/10)
    saveGIF({for (i in min(all_frames):max(all_frames)) {
      play_df_frame <- play_df %>% filter(frameId == i)
      pred_df_frame <- pred_df %>% filter(frameId == i, omit == 0) 
      min_x = 10
      max_x = 110
      min_y = 0
      max_y = 54
      main <- ggplot() + geom_tile(data = pred_df_frame, aes(x = x, y = y, fill = prob), width = 10, height = 10)
      main <- main +
        scale_fill_gradient(low = "grey", high = "brown1", limits = c(0, max_p)) +
            geom_vline(aes(xintercept = seq(round_any(min_x, 5, f = floor), 
                                          round_any(max_x, 5, f = ceiling), by = 5)), 
                     color = 'white') +
          geom_segment(aes(x = seq(round_any(min_x, 5, f = floor), round_any(max_x, 5, f = ceiling), by = 1 ), 
                           y = rep(70.9 / 3 - 0.5, length(seq(round_any(min_x, 5, f = floor), 
                                                                 round_any(max_x, 5, f = ceiling), by = 1 )) ), 
                           xend = seq(round_any(min_x, 5, f = floor), round_any(max_x, 5, f = ceiling), by = 1 ), 
                           yend = rep(70.9 / 3 + 0.5, length(seq(round_any(min_x, 5, f = floor), 
                                                                 round_any(max_x, 5, f = ceiling), by = 1 ))) ), 
                       color = 'white') +
          geom_segment(aes(x = seq(round_any(min_x, 5, f = floor), round_any(max_x, 5, f = ceiling), by = 1 ), 
                           y = rep(70.8 / 3 + 18.5 / 3 - 0.5, length(seq(round_any(min_x, 5, f = floor), 
                                                                 round_any(max_x, 5, f = ceiling), by = 1 )) ), 
                           xend = seq(round_any(min_x, 5, f = floor), round_any(max_x, 5, f = ceiling), by = 1 ), 
                           yend = rep(70.8 / 3 + 18.5 / 3 + 0.5, length(seq(round_any(min_x, 5, f = floor), 
                                                                 round_any(max_x, 5, f = ceiling), by = 1 ))) ), 
                       color = 'white') + ylab("") + xlab("") + 
        geom_hline(yintercept = 0, color = 'white')  + geom_hline(yintercept = 54, color = 'white') + geom_vline(xintercept = 0, color = 'white') + 
        geom_vline(xintercept = 120, color = 'white')  + 
        geom_point(data = play_df_frame, aes(x = x, y = y, size = type, color = type, shape = type))  +
        scale_shape_manual(values = c(20, 18, 18)) +
        scale_size_manual(values = c(2, 5, 5)) +
        scale_color_manual(values = c("white", "cornflowerblue", "lightseagreen")) +
        labs(title = "Tackle Classifier Example", x = "", y = "", caption = describe) + xlim(0, 120) + ylim(0, 54) + theme_minimal() 
    print(main)
    print(paste0("Frame ", i))
    ani.pause()}
    },movie.name="facet_zoom_2.gif",ani.width = 600, ani.height = 600)
}

plot_features <- function(game_id, play_id) {
  features <- read.csv(paste0("/Users/nickbachelder/Desktop/Personal Code/Kaggle/Tackles/features_", game_id, "_", play_id, ".csv")) %>% 
      dplyr::select(-X) %>% pivot_longer(cols = !c(x, y, frameId)) 
    
    oopt = ani.options(interval = 1/10)
    saveGIF({for (i in 1:(max(features$frameId)-1)) {
      image_this_frame <- features %>% filter(frameId == i) 
      plots_list <- list()
      # Iterate over unique feature names and create heat maps
      for (feature_name in unique(image_this_frame$name)) {
        feature_data <- subset(image_this_frame, name == feature_name)
        
        # Create a ggplot for each feature
        plot <- ggplot(feature_data, aes(x = x, y = y, fill = value)) +
          geom_tile() +
          ggtitle(feature_name) +
          scale_fill_gradient2(low = "mediumpurple1", mid = 'azure1', high = "red", midpoint = 0) + 
          guides(fill="none") + theme_void() + xlab("") + ylab("")  # Adjust the color scale as needed
        
        # Append the plot to the list
        plots_list[[feature_name]] <- plot
      }
      
      # Arrange the plots using ggarrange
      p <- ggarrange(plotlist = plots_list, ncol = 3, nrow = 4)
      print(p)
      print(paste0(i, " out of ", max(features$frameId) - 1))
      ani.pause()}
    }, movie.name="facet_zoom.gif",ani.width = 600, ani.height = 300)
}

plot_combine_play_contribution <- function(game_id, play_id) {
    pred_df <- read.csv(paste0("/Users/nickbachelder/Desktop/Personal Code/Kaggle/Tackles/", game_id, "_", play_id, ".csv")) %>% dplyr::select(-X) %>%
      mutate(x = as.numeric(x), y = as.numeric(y))
    play_df <- tracking %>% filter(gameId == game_id, playId == play_id) %>%
      dplyr::mutate(type = case_when(position %in% c("QB", "TE",  "WR", "G", "OLB", "RB", "C", "FB") ~ "offense", 
                               is.na(nflId) ~ "ball",
                               TRUE ~ "defense"))
    describe <- (plays %>% filter(gameId == game_id, playId == play_id))$playDescription[1]
    all_frames <- unique(play_df$frameId)
    max_p <- max(pred_df$prob)
    oopt = ani.options(interval = 1/10)
    saveGIF({for (i in min(all_frames):max(all_frames)) {
      play_df_frame <- play_df %>% filter(frameId == i)
      pred_df_frame <- pred_df %>% filter(frameId == i, omit == 0) 
      min_x = 10
      max_x = 110
      min_y = 0
      max_y = 54
      main <- ggplot() + geom_tile(data = pred_df_frame, aes(x = x, y = y, fill = prob), width = 10, height = 10)
      main <- main +
        scale_fill_gradient(low = "grey", high = "brown1", limits = c(0, max_p)) +
            geom_vline(aes(xintercept = seq(round_any(min_x, 5, f = floor), 
                                          round_any(max_x, 5, f = ceiling), by = 5)), 
                     color = 'white') +
          geom_segment(aes(x = seq(round_any(min_x, 5, f = floor), round_any(max_x, 5, f = ceiling), by = 1 ), 
                           y = rep(70.9 / 3 - 0.5, length(seq(round_any(min_x, 5, f = floor), 
                                                                 round_any(max_x, 5, f = ceiling), by = 1 )) ), 
                           xend = seq(round_any(min_x, 5, f = floor), round_any(max_x, 5, f = ceiling), by = 1 ), 
                           yend = rep(70.9 / 3 + 0.5, length(seq(round_any(min_x, 5, f = floor), 
                                                                 round_any(max_x, 5, f = ceiling), by = 1 ))) ), 
                       color = 'white') +
          geom_segment(aes(x = seq(round_any(min_x, 5, f = floor), round_any(max_x, 5, f = ceiling), by = 1 ), 
                           y = rep(70.8 / 3 + 18.5 / 3 - 0.5, length(seq(round_any(min_x, 5, f = floor), 
                                                                 round_any(max_x, 5, f = ceiling), by = 1 )) ), 
                           xend = seq(round_any(min_x, 5, f = floor), round_any(max_x, 5, f = ceiling), by = 1 ), 
                           yend = rep(70.8 / 3 + 18.5 / 3 + 0.5, length(seq(round_any(min_x, 5, f = floor), 
                                                                 round_any(max_x, 5, f = ceiling), by = 1 ))) ), 
                       color = 'white') + ylab("") + xlab("") + 
        geom_hline(yintercept = 0, color = 'white')  + geom_hline(yintercept = 54, color = 'white') + geom_vline(xintercept = 0, color = 'white') + 
        geom_vline(xintercept = 120, color = 'white')  + 
        geom_point(data = play_df_frame, aes(x = x, y = y, size = type, color = type, shape = type))  +
        scale_shape_manual(values = c(20, 18, 18)) +
        scale_size_manual(values = c(2, 5, 5)) +
        scale_color_manual(values = c("white", "cornflowerblue", "lightseagreen")) +
        labs(title = "Tackle Classifier Example", x = "", y = "", caption = describe) + xlim(0, 120) + ylim(0, 54) + theme_minimal() 
      plot_list <- list()
      all_omit <- (pred_df %>% filter(omit!=0))$omit %>% unique()
      iter <- 1
      for (id in all_omit) {
        play_df_frame <- play_df %>% filter(frameId == i) %>% filter(nflId == id | type == 'ball')
        name <- (play_df_frame %>% filter(nflId == id))$displayName[1]
        pred_df_frame <- pred_df %>% filter(frameId == i, omit == id) 
        p <- ggplot() + geom_tile(data = pred_df_frame, aes(x = x, y = y, fill = prob), width = 10, height = 10)  +
          scale_fill_gradient2(midpoint = 0, low = "blue", mid = "grey", high = "brown1", limits = c(-.1, .1)) +
              geom_vline(aes(xintercept = seq(round_any(min_x, 5, f = floor), 
                                            round_any(max_x, 5, f = ceiling), by = 5)), 
                       color = 'white') +
            geom_segment(aes(x = seq(round_any(min_x, 5, f = floor), round_any(max_x, 5, f = ceiling), by = 1 ), 
                             y = rep(70.9 / 3 - 0.5, length(seq(round_any(min_x, 5, f = floor), 
                                                                   round_any(max_x, 5, f = ceiling), by = 1 )) ), 
                             xend = seq(round_any(min_x, 5, f = floor), round_any(max_x, 5, f = ceiling), by = 1 ), 
                             yend = rep(70.9 / 3 + 0.5, length(seq(round_any(min_x, 5, f = floor), 
                                                                   round_any(max_x, 5, f = ceiling), by = 1 ))) ), 
                         color = 'white') +
            geom_segment(aes(x = seq(round_any(min_x, 5, f = floor), round_any(max_x, 5, f = ceiling), by = 1 ), 
                             y = rep(70.8 / 3 + 18.5 / 3 - 0.5, length(seq(round_any(min_x, 5, f = floor), 
                                                                   round_any(max_x, 5, f = ceiling), by = 1 )) ), 
                             xend = seq(round_any(min_x, 5, f = floor), round_any(max_x, 5, f = ceiling), by = 1 ), 
                             yend = rep(70.8 / 3 + 18.5 / 3 + 0.5, length(seq(round_any(min_x, 5, f = floor), 
                                                                   round_any(max_x, 5, f = ceiling), by = 1 ))) ), 
                         color = 'white') + ylab("") + xlab("") + 
          geom_hline(yintercept = 0, color = 'white')  + geom_hline(yintercept = 54, color = 'white') + geom_vline(xintercept = 0, color = 'white') + 
          geom_vline(xintercept = 120, color = 'white') + xlim(0, 120) + ylim(0, 54)  +
          geom_point(data = play_df_frame, aes(x = x, y = y, size = type, color = type, shape = type))  +
          scale_shape_manual(values = c(20, 18, 18)) +
          scale_size_manual(values = c(2, 5, 5)) +
          scale_color_manual(values = c("white", "cornflowerblue", "lightseagreen")) + theme_void() + theme(legend.position = "none") + ggtitle(name)
        plot_list[[iter]] <- p
        iter = iter+1
      }
      arranged_plots <- ggarrange(plotlist = plot_list, ncol = 3, nrow = 5)
      arranged_plots2 <-ggarrange(plotlist = list(main, arranged_plots), ncol = 1, nrow = 2)
      print(arranged_plots2)
      print(paste0("Frame ", i))
      ani.pause()}
    },movie.name="facet_zoom_2.gif",ani.width = 600, ani.height = 600)
}
```

```{r}
game_id = 2022090800
play_id = 101

plot_combine_play_contribution(game_id, play_id)
plot_play(game_id, play_id)
```






```{r}
pred_df <- read.csv(paste0("/Users/nickbachelder/Desktop/Personal Code/Kaggle/Tackles/", game_id, "_", play_id, ".csv")) %>% dplyr::select(-X) %>%
      mutate(x = as.numeric(x), y = as.numeric(y))
pred_df %>% filter(omit==45287) %>%
  left_join(pred_df %>% filter(omit==0) %>% dplyr::select(frameId,exp_eop) %>% 
              dplyr::rename(exp_eop_orig = exp_eop)) %>% dplyr::select(frameId, exp_eop, exp_eop_orig, exp_contribution) %>% distinct()

pred_df %>% filter(frameId == 6, omit == 0) %>% filter(prob > 0.05)
```




$$\begin{bmatrix}
    \begin{bmatrix} \mu_{x1}& \mu_{y1} \end{bmatrix} \\
    . \\
    .\\
     \begin{bmatrix}  \mu_{xK}& \mu_{yK} \end{bmatrix}   \\
\end{bmatrix} $$

$$\begin{bmatrix}
    \begin{bmatrix}
    \sigma_{x1} & 0 \\
    0 & \sigma_{y1}   \\
\end{bmatrix} \\
. \\
. \\
     \begin{bmatrix}
    \sigma_{xK}& 0 \\
     0 & \sigma_{yK}   \\
\end{bmatrix}   \\
\end{bmatrix} $$

$$\begin{bmatrix}
    p{1}\\
    . \\
    . \\
     p{K}   \\
\end{bmatrix} $$


$$f(\text{End of Play}_i = \begin{bmatrix} x \\ y \end{bmatrix}) = \sum_{k=1}^{K}p_i \cdot \text{Normal}( \begin{bmatrix} x \\ y \end{bmatrix} ; \mu = \begin{bmatrix} \mu_{xk} \\ \mu_{yk} \end{bmatrix}, \Sigma = \begin{bmatrix}
    \sigma_{xk}& 0 \\
     0 & \sigma_{yk}   \\
\end{bmatrix})  $$












```{r}
contribution_df %>% filter(rank(estimated) < 10)
```



```{r}
tracking %>% filter(gameId == game_id, playId == play_id)
```



```{r}
contribution_df %>% filter(game_id == game_id, play_id == play_id)
```


```{r}
contribution_df <- read.csv(here::here("data/contribution_df.csv")) 

ggplot(data=contribution_df) + geom_density(aes(x=estimated))

cumulative_contribution_df <-  contribution_df %>% arrange(play_id) %>% group_by(nflId, displayName, position) %>% 
  mutate(play_number = rank(play_id), cum_contribution = cumsum(estimated), 
         avg_contribution= mean(cum_contribution),
         final_cum_contribution = cum_contribution[play_number == max(play_number)],
         total_play_num = max(play_number)) %>% ungroup()

eys_rank <- cumulative_contribution_df %>% dplyr::select(nflId, displayName, position, final_cum_contribution) %>% distinct() %>%
  mutate(rank_cum_contribution = rank(-final_cum_contribution)) %>% dplyr::select(-final_cum_contribution) %>%
  arrange(rank_cum_contribution) %>% 
  mutate(best_or_worst = ifelse(rank_cum_contribution < 3 | rank_cum_contribution > max(rank_cum_contribution)-3, 1, 0))

final_eys <- cumulative_contribution_df %>% dplyr::select(nflId, displayName, position, play_number, final_cum_contribution) %>% 
  group_by(nflId, displayName, position) %>% filter(play_number == max(play_number)) %>% ungroup() %>% 
  left_join(eys_rank %>% dplyr::select(nflId, displayName, best_or_worst) %>% distinct(), on = c("nflId", "displayName")) %>%
  filter(best_or_worst == 1)

cumulative_contribution_df %>% left_join(eys_rank, on = c('nflId', 'displayName', 'position', 'final_cum_contribution'))  %>%
  ggplot() + 
  geom_line(aes(x = play_number, y = cum_contribution, group = nflId, alpha = best_or_worst)) +
  geom_text_repel(data = final_eys, aes(x = play_number, y = final_cum_contribution, label=displayName), color = "blue") +
  theme_classic() + ggtitle("Cumulative Expected Yards Saved") + xlab("Play Number") + ylab("Cumulative Expected Yards Saved (EYS)")
```

```{r}
cumulative_contribution_df %>% dplyr::select(nflId, displayName, position, final_cum_contribution) %>%
  ggplot(aes(x = position, y = final_cum_contribution)) + geom_violin() + theme_classic()
  

general_table <- cumulative_contribution_df  %>% dplyr::select(nflId, displayName, position, final_cum_contribution, avg_contribution, total_play_num) %>% distinct() %>%
  mutate(rank_cum_contribution = rank(-final_cum_contribution), rank_avg_contribution = rank(-avg_contribution)) %>%
  arrange(rank_cum_contribution) 

general_table %>% filter(rank_cum_contribution < 10)  %>% gt() %>% gt_theme_538()
general_table %>% filter(rank_avg_contribution < 10)  %>% gt() %>% gt_theme_538()

general_table %>% ggplot() + geom_point(aes(x = total_play_num, y = avg_contribution))

cor(general_table$total_play_num, general_table$avg_contribution)
```


```{r}
general_table %>%
  left_join(
    tackles %>% dplyr::select(nflId, tackle, assist, forcedFumble) %>% 
      distinct() %>% group_by(nflId) %>% dplyr::summarise(total_tackle_involvement = sum(tackle, assist, forcedFumble)) %>% ungroup(),
    on = c("nflId")) %>% ggplot(aes(x=rank_cum_contribution, y=total_tackle_involvement)) + geom_point()
```




```{r}
frames <- seq(1,30)
all_contained <- c()
for (trial in seq(1, 1000)) {
  values <- c()
  for (i in seq(1, 100)) {
    values[i] <- sample(frames, 1)
  all_contained[trial] = length(unique(values))/30
  }
}
mean(all_contained)
```

```{r}
tracking %>% filter(frameId >20)
```


